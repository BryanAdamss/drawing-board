{"version":3,"file":"drawing-board.umd.js","sources":["../src/libs/file-convert.ts","../src/libs/touch-offset.ts","../src/libs/browser.ts","../src/libs/utils.ts","../src/libs/dom.ts","../src/main.ts","../src/libs/err-msg.ts"],"sourcesContent":["/**\r\n * @author GuangHui\r\n * @description 文件相关类型转换函数\r\n */\r\nimport { IeCompatibleBlob } from '../types/blob'\r\n\r\nimport { isIE } from './browser.js'\r\n\r\n/**\r\n * blob转File\r\n *\r\n * @export File\r\n * @param {Blob} blob blob\r\n * @param {String} name filename\r\n * @returns\r\n */\r\nexport function blob2File(\r\n  blob: IeCompatibleBlob,\r\n  name: string\r\n): File | IeCompatibleBlob {\r\n  if (isIE) {\r\n    // IE不支持new File\r\n    blob.lastModifiedDate = new Date()\r\n    blob.name = name\r\n    return blob\r\n  } else {\r\n    return new File([blob], name, { type: blob.type })\r\n  }\r\n}\r\n","import { ones, inv, multiply } from 'mathjs'\r\n\r\nexport function getOffsetPosition(x: number, y: number, elOrCache: any) {\r\n  function getVertexPosition(el: any) {\r\n    let currentTarget = el\r\n    let top = 0\r\n    let left = 0\r\n    while (currentTarget !== null) {\r\n      top += currentTarget.offsetTop\r\n      left += currentTarget.offsetLeft\r\n      currentTarget = currentTarget.offsetParent\r\n    }\r\n    return { top, left }\r\n  }\r\n\r\n  function getTranformData(el: any) {\r\n    let style = window.getComputedStyle(el)\r\n    let transform: any = style.transform || ''\r\n    let transformOrigin = style.transformOrigin || ''\r\n\r\n    let origin = { x: 0, y: 0 }\r\n    let matrix = ones([3, 3])\r\n    if (transform !== 'none') {\r\n      let originArray = transformOrigin.split(' ')\r\n      origin.x = parseInt(originArray[0])\r\n      origin.y = parseInt(originArray[1])\r\n\r\n      let matrixString = transform.match(/\\(([^)]*)\\)/)[1]\r\n      let stringArray: any = matrixString.split(',')\r\n      let temp: any = []\r\n      stringArray.forEach((value: any) => {\r\n        temp.push(parseFloat(value.trim()))\r\n      })\r\n      temp = [\r\n        [temp[0], temp[2], temp[4]],\r\n        [temp[1], temp[3], temp[5]],\r\n        [0, 0, 1],\r\n      ]\r\n\r\n      matrix = inv(temp)\r\n    } else {\r\n      matrix = [\r\n        [1, 0, 0],\r\n        [0, 1, 0],\r\n        [0, 0, 1],\r\n      ]\r\n    }\r\n    return { matrix, origin }\r\n  }\r\n\r\n  function computPosition(data: any) {\r\n    data.forEach((obj: any) => {\r\n      let {\r\n        temp,\r\n        origin,\r\n        vertex: { left, top },\r\n      } = obj as any\r\n      x = x - left - origin.x\r\n      y = y - top - origin.y\r\n      let result = multiply(temp, [x, y, 1])\r\n      x = result[0] + origin.x\r\n      y = result[1] + origin.y\r\n    })\r\n    return { x, y }\r\n  }\r\n\r\n  let data = []\r\n  if (elOrCache instanceof Node) {\r\n    var el = elOrCache\r\n    while (el !== null && el.nodeType === 1) {\r\n      let { left, top } = getVertexPosition(el)\r\n      let transformData = getTranformData(el)\r\n      let temp = transformData.matrix\r\n      let origin = transformData.origin\r\n\r\n      if (data.length > 0) {\r\n        data[0].vertex.left -= left\r\n        data[0].vertex.top -= top\r\n      }\r\n      data.unshift({\r\n        temp,\r\n        origin,\r\n        vertex: {\r\n          left,\r\n          top,\r\n        },\r\n      })\r\n      el = el.parentNode as Node\r\n    }\r\n  } else if (elOrCache instanceof Array) {\r\n    data = elOrCache\r\n  }\r\n  let pos = computPosition(data)\r\n  return { x: pos.x, y: pos.y, data }\r\n}\r\n","/**\r\n * @author GuangHui\r\n * @description 浏览器判断\r\n */\r\n\r\nexport const inBrowser: boolean = typeof window !== 'undefined'\r\n\r\nexport const UA: string = inBrowser\r\n  ? window.navigator.userAgent.toLowerCase()\r\n  : ''\r\n\r\nexport const isIE: boolean = UA ? /msie|trident/.test(UA) : false\r\n","/**\r\n * @author GuangHui\r\n * @description utils\r\n */\r\n\r\nexport const getImageFromURL = (imgURL: string): Promise<HTMLImageElement> =>\r\n  new Promise((resolve, reject) => {\r\n    if (!/^(http[s]?)|(data:image)/.test(imgURL)) {\r\n      reject(new Error('图片url格式不正确'))\r\n      return\r\n    }\r\n\r\n    const image = new Image()\r\n    image.src = imgURL\r\n\r\n    image.onload = () => {\r\n      resolve(image)\r\n    }\r\n\r\n    image.onerror = reject\r\n\r\n    // 确保从缓存加载图片时，也能触发load事件\r\n    if (image.complete || image.complete === undefined) {\r\n      image.src =\r\n        'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=='\r\n      image.src = imgURL\r\n    }\r\n  })\r\n","/**\r\n * @author GuangHui\r\n * @description dom\r\n */\r\n\r\nexport const $: (selector: string) => HTMLElement | null = selector =>\r\n  document.querySelector(selector)\r\n","/**\r\n * @author GuangHui\r\n * @description 绘图板\r\n */\r\n\r\nimport {\r\n  INTERACTIVE_MODE,\r\n  IMG_TYPE,\r\n  PEN_MODE,\r\n  Options,\r\n  Point,\r\n  EventItem,\r\n  PenStyle,\r\n  EventAction,\r\n  EventPointerType,\r\n  EventItemCondition,\r\n} from './types/drawing-board'\r\nimport { IeCompatibleBlob } from './types/blob'\r\n\r\nimport { blob2File } from './libs/file-convert'\r\nimport { getImageFromURL } from './libs/utils'\r\nimport { $ } from './libs/dom'\r\nimport {\r\n  MSG_CONTAINER_MISS_SELECTOR,\r\n  MSG_CONTAINER_NOT_FOUND,\r\n  MSG_ANGLE_NOT_LAWFUL,\r\n  MSG_CTX_CANT_GET,\r\n  MSG_LAST_DRAG_POINT_NOT_FOUNT,\r\n  MSG_LAST_PAINT_POINT_NOT_FOUNT,\r\n  MSG_EVENT_TARGET_NOT_FOUNT,\r\n  MSG_BG_URL_NOT_LAWFUL,\r\n  MSG_BLOB_CANT_GEN,\r\n  MSG_DATAURL_CANT_GEN,\r\n} from './libs/err-msg'\r\n\r\nimport { getOffsetPosition } from './libs/touch-offset'\r\nclass DrawingBoard {\r\n  static INTERACTIVE_MODE_ENUM: INTERACTIVE_MODE[] = ['mouse', 'touch', 'both'] // 支持的交互模式枚举\r\n  static IMG_TYPE_ENUM: IMG_TYPE[] = ['jpg', 'jpeg', 'png', 'webp'] // 支持的图片类型枚举\r\n  static PEN_MODE_ENUM: PEN_MODE[] = ['paint', 'drag', 'empty'] // 支持的画笔模式枚举\r\n\r\n  static DEFAULT_WIDTH: number = 300 // 默认宽度\r\n  static DEFAULT_HEIGHT: number = 150 // 默认高度\r\n\r\n  static LIMIT_MIN_REVOKE_STEPS = 10 // 最大撤销步数 下限值\r\n  static LIMIT_MAX_REVOKE_STEPS = 50 // 最大撤销步数 上限值\r\n\r\n  static LIMIT_MIN_SCALE = 0.1 // 最小缩放值，最小需做限制，最大无需限制\r\n\r\n  static DEFAULT_SCALE = 1 // 默认缩放值\r\n  static DEFAULT_MAX_SCALE = 5 // 默认最大缩放值\r\n\r\n  private static _defaultOptions: Options = {\r\n    size: [], // canvas尺寸，默认[300,150]\r\n    className: '', // 自定义样式类\r\n\r\n    manualMount: false, // 手动挂载\r\n\r\n    maxRevokeSteps: 10, // 最大回退步数\r\n\r\n    interactiveMode: 'mouse', // 交互模式 enum:['mouse','touch','both'] ,both将同时绑定mouse、touch事件(PointerEvent存在兼容性问题，放弃使用)\r\n\r\n    penMode: 'empty', // 'paint' | 'drag' | 'empty' 画笔模式\r\n\r\n    penColor: 'red', // 画笔颜色\r\n    penWidth: 6, // 画笔粗细\r\n\r\n    bgImgURL: '', // 背景图url或base64\r\n    bgImgRotate: 0, // 背景图旋转角度\r\n    bgColor: '#fff', // 背景色\r\n\r\n    onRevokeStackChange: null, // 撤销栈改变时的回调\r\n    onPaintEnd: null, // 绘制一笔结束的回调\r\n\r\n    minScale: 1, // 最小缩放比例\r\n    maxScale: 3, // 最大缩放比例\r\n\r\n    initialScale: 1, // 初始缩放比例\r\n\r\n    scaleTransition: true, // 是否开启缩放动画\r\n    scaleStep: 0.1, // 缩放步进值\r\n  }\r\n\r\n  originalOptions: Options // 原始选项\r\n\r\n  options: Options // 合并后的选项\r\n\r\n  container: HTMLElement\r\n  el: HTMLCanvasElement | null\r\n\r\n  width: number\r\n  height: number\r\n\r\n  manualMount: boolean // 是否手动挂载\r\n\r\n  revokeStack: any[] // 撤销栈\r\n\r\n  MAX_REVOKE_STEPS: number // 最大撤销步数\r\n\r\n  isPainting: boolean // 是否绘制中\r\n  lastPaintPoint: Point | null // 最后一个绘制点坐标\r\n\r\n  isDraging: boolean // 是否拖拽中\r\n  lastDragPoint: Point | null // 最后一个拖拽点坐标\r\n  dragTransformX: number // x偏移值\r\n  dragTransformY: number // Y偏移值\r\n\r\n  penMode: PEN_MODE // 画笔模式\r\n  interactiveMode: INTERACTIVE_MODE // 交互模式\r\n  eventList: EventItem[] // 事件列表\r\n\r\n  penColor: string // 画笔颜色\r\n  penWidth: number // 画笔粗细\r\n\r\n  className: string // 自定义样式类\r\n\r\n  bgImgURL: string // 背景图url\r\n  bgColor: string // 背景色\r\n  bgImgRotate: number // 背景图旋转角度\r\n  _bgImgObject: CanvasImageSource | null // 背景图Image对象\r\n  originalSize: number[] // 原始尺寸\r\n\r\n  onRevokeStackChange: any // 撤销回调\r\n  onPaintEnd: any // 绘制结束回调\r\n\r\n  paintCount: number // 绘制次数\r\n\r\n  scaleTransition: boolean // 缩放动画\r\n\r\n  minScale: number // 最小缩放值\r\n  maxScale: number // 最大缩放值\r\n\r\n  initialScale: number // 初始缩放值\r\n  scale: number // 当前缩放值\r\n\r\n  scaleStep: number // 缩放步进值\r\n\r\n  ctx: CanvasRenderingContext2D | null // 绘图上下文\r\n\r\n  /**\r\n   * Creates an instance of DrawingBoard.\r\n   *\r\n   * @param {(HTMLElement | string)} container 选择器或el\r\n   * @param {Options} options 选项\r\n   * @memberof DrawingBoard\r\n   */\r\n  constructor(container: HTMLElement | string, options: Options) {\r\n    if (!container) throw new Error(MSG_CONTAINER_MISS_SELECTOR)\r\n\r\n    this.container = this._getContainer(container)\r\n\r\n    this.originalOptions = options\r\n\r\n    this.options = {\r\n      ...DrawingBoard._defaultOptions,\r\n      ...options,\r\n    }\r\n\r\n    const {\r\n      size,\r\n      className,\r\n      manualMount,\r\n      maxRevokeSteps,\r\n      interactiveMode,\r\n      penColor,\r\n      penWidth,\r\n      bgImgURL,\r\n      bgImgRotate,\r\n      bgColor,\r\n      onRevokeStackChange,\r\n      onPaintEnd,\r\n      penMode,\r\n      minScale,\r\n      maxScale,\r\n      initialScale,\r\n      scaleTransition,\r\n      scaleStep,\r\n    } = this.options\r\n\r\n    // 尺寸未传，则使用容器的尺寸\r\n    const [width, height] = size || []\r\n\r\n    this.width = DrawingBoard.DEFAULT_WIDTH\r\n    this.height = DrawingBoard.DEFAULT_HEIGHT\r\n\r\n    this.setSize([\r\n      width == null ? DrawingBoard.DEFAULT_WIDTH : width,\r\n      height == null ? DrawingBoard.DEFAULT_HEIGHT : height,\r\n    ])\r\n\r\n    this.manualMount = !!manualMount\r\n\r\n    this.revokeStack = []\r\n\r\n    this.MAX_REVOKE_STEPS = this._getLawfulMaxRevokeSteps(\r\n      Number(maxRevokeSteps)\r\n    )\r\n\r\n    this.isPainting = false\r\n    this.lastPaintPoint = null\r\n\r\n    this.isDraging = false\r\n    this.lastDragPoint = null\r\n    this.dragTransformX = 0\r\n    this.dragTransformY = 0\r\n\r\n    this.penMode = this._getPenMode(penMode)\r\n\r\n    this.interactiveMode = this._getInteractiveMode(interactiveMode)\r\n\r\n    this.eventList = this._makeEventList()\r\n\r\n    this.penColor = this._getPenColor(penColor)\r\n    this.penWidth = this._getPenWidth(penWidth)\r\n\r\n    this.className = this._getClassName(className)\r\n\r\n    this.bgImgURL = bgImgURL || ''\r\n    this.bgColor = bgColor || ''\r\n    this.bgImgRotate = this._getLawfulRotateAngle(bgImgRotate)\r\n    this._bgImgObject = null\r\n    this.originalSize = []\r\n    if (bgImgURL) this._getImgAndDraw(bgImgURL) // 有设置背景图，则获取并绘制\r\n\r\n    this.onRevokeStackChange = onRevokeStackChange\r\n    this.onPaintEnd = onPaintEnd\r\n\r\n    this.paintCount = 0 // 记录绘制次数\r\n\r\n    this.scaleTransition = !!scaleTransition // 缩放动画\r\n\r\n    this.scaleStep =\r\n      typeof scaleStep !== 'number' || isNaN(scaleStep) ? 0.1 : scaleStep\r\n\r\n    // 限制最小、最大缩放比例\r\n    this.minScale = this._getLawfulMinScale(minScale)\r\n    this.maxScale = this._getLawfulMaxScale(maxScale)\r\n\r\n    this.initialScale = this._getLawfulScale(initialScale) // 获取合法初始缩放值\r\n\r\n    this.scale = this.initialScale // 获取合法的缩放值\r\n    // 下一循环，等待mount后，设置缩放\r\n    setTimeout(() => {\r\n      this._handleScaleChange()\r\n    }, 0)\r\n\r\n    if (this.container) this.container.style.overflow = 'hidden' // 设置容器溢出隐藏，防止缩放展示出现异常\r\n\r\n    this.el = null\r\n    this.ctx = null\r\n\r\n    if (!this.manualMount) this.mount() // 不需要手动挂载时，自动挂载\r\n  }\r\n\r\n  /**\r\n   * 获取合法的缩放值\r\n   *\r\n   * @private\r\n   * @param {*} scale 缩放值\r\n   * @returns {number} 合法的缩放值\r\n   * @memberof DrawingBoard\r\n   */\r\n  private _getLawfulScale(scale: any): number {\r\n    if (typeof scale !== 'number' || isNaN(scale))\r\n      return DrawingBoard.DEFAULT_SCALE\r\n\r\n    if (scale < this.minScale) return this.minScale\r\n\r\n    if (scale > this.maxScale) return this.maxScale\r\n\r\n    return scale\r\n  }\r\n\r\n  /**\r\n   * 获取合法的最小缩放值\r\n   *\r\n   * @private\r\n   * @param {*} scale 缩放值\r\n   * @returns {number} 合法的最小缩放值\r\n   * @memberof DrawingBoard\r\n   */\r\n  private _getLawfulMinScale(scale: any): number {\r\n    if (\r\n      typeof scale !== 'number' ||\r\n      isNaN(scale) ||\r\n      scale < DrawingBoard.LIMIT_MIN_SCALE\r\n    )\r\n      return DrawingBoard.LIMIT_MIN_SCALE\r\n\r\n    return scale\r\n  }\r\n\r\n  /**\r\n   * 获取合法的最大缩放值\r\n   *\r\n   * @private\r\n   * @param {*} scale 缩放值\r\n   * @returns {number} 合法的最大缩放值\r\n   * @memberof DrawingBoard\r\n   */\r\n  private _getLawfulMaxScale(scale: any): number {\r\n    if (\r\n      typeof scale !== 'number' ||\r\n      isNaN(scale) ||\r\n      scale < DrawingBoard.LIMIT_MIN_SCALE\r\n    )\r\n      return DrawingBoard.DEFAULT_MAX_SCALE\r\n\r\n    return scale\r\n  }\r\n\r\n  /**\r\n   * 获取合法的交互模式\r\n   *\r\n   * @private\r\n   * @param {*} mode 模式字符串\r\n   * @returns {PEN_MODE} 模式字符串\r\n   * @memberof DrawingBoard\r\n   */\r\n  private _getInteractiveMode(mode: any): INTERACTIVE_MODE {\r\n    return DrawingBoard.INTERACTIVE_MODE_ENUM.includes(mode) ? mode : 'mouse'\r\n  }\r\n\r\n  /**\r\n   * 获取合法的画笔模式\r\n   *\r\n   * @private\r\n   * @param {*} mode 模式字符串\r\n   * @returns {PEN_MODE} 画笔模式\r\n   * @memberof DrawingBoard\r\n   */\r\n  private _getPenMode(mode: any): PEN_MODE {\r\n    return DrawingBoard.PEN_MODE_ENUM.includes(mode) ? mode : 'empty'\r\n  }\r\n\r\n  /**\r\n   * 获取container容器\r\n   *\r\n   * @private\r\n   * @param {(HTMLElement | string)} container 选择器或el\r\n   * @returns container容器el\r\n   * @memberof DrawingBoard\r\n   */\r\n  private _getContainer(container: HTMLElement | string): HTMLElement {\r\n    if (container instanceof HTMLElement) return container\r\n\r\n    const el = $(container)\r\n    if (el == null) {\r\n      throw new Error(MSG_CONTAINER_NOT_FOUND)\r\n    } else {\r\n      return el\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 获取合法className\r\n   *\r\n   * @private\r\n   * @param {*} name 样式类\r\n   * @returns {string} 合法样式类\r\n   * @memberof DrawingBoard\r\n   */\r\n  private _getClassName(name: any): string {\r\n    return name && typeof name === 'string' ? name : ''\r\n  }\r\n\r\n  /**\r\n   * 获取合法penColor\r\n   *\r\n   * @private\r\n   * @param {*} color 颜色\r\n   * @returns {string} 合法颜色值\r\n   * @memberof DrawingBoard\r\n   */\r\n  private _getPenColor(color: any): string {\r\n    return !color || typeof color !== 'string' ? 'red' : color\r\n  }\r\n\r\n  /**\r\n   * 获取合法penWidth\r\n   *\r\n   * @private\r\n   * @param {*} width 粗细\r\n   * @returns {number}  合法画笔粗细\r\n   * @memberof DrawingBoard\r\n   */\r\n  private _getPenWidth(width: any): number {\r\n    return !width || typeof width !== 'number' || isNaN(width) || width <= 0\r\n      ? 6\r\n      : width\r\n  }\r\n\r\n  /**\r\n   * 获取合法角度值(逆时针旋转角度记录为正值，-90度 记录为270；450记录为90,10度记录为0,55度记录为90)\r\n   *\r\n   * @private\r\n   * @param {*} angle 角度\r\n   * @returns {number} 合法角度值\r\n   * @memberof DrawingBoard\r\n   */\r\n  private _getLawfulRotateAngle(angle: any): number {\r\n    if (typeof angle !== 'number' || isNaN(angle))\r\n      throw new Error(MSG_ANGLE_NOT_LAWFUL)\r\n\r\n    const tempAngle = angle % 360\r\n    const newAngle = tempAngle < 0 ? tempAngle + 360 : tempAngle\r\n    // 角度>=45，计入下一个90度，保证返回的角度 % 90 ===0\r\n    const roundAngle =\r\n      newAngle % 90 >= 45\r\n        ? (Math.ceil(newAngle / 90) * 90) % 360\r\n        : (Math.floor(newAngle / 90) * 90) % 360\r\n\r\n    // 可能存在-0\r\n    return Math.abs(roundAngle)\r\n  }\r\n\r\n  /**\r\n   * 获取事件相对触发对象的偏移值\r\n   *\r\n   * @private\r\n   * @param {(MouseEvent | TouchEvent)} e 事件对象\r\n   * @returns {Point} 坐标\r\n   * @memberof DrawingBoard\r\n   */\r\n  private _getPointOffset(e: MouseEvent | TouchEvent): Point {\r\n    if (e instanceof MouseEvent) {\r\n      return {\r\n        x: e.offsetX,\r\n        y: e.offsetY,\r\n      }\r\n    } else {\r\n      // console.log(e)\r\n      // const { touches, target } = e\r\n      // if (target == null) throw new Error(MSG_EVENT_TARGET_NOT_FOUNT)\r\n\r\n      // const { clientX, clientY } = touches[0]\r\n      // const { left, top } = (target as Element).getBoundingClientRect()\r\n\r\n      // const x = Math.floor((clientX - left) / this.scale)\r\n      // const y = Math.floor((clientY - top) / this.scale)\r\n\r\n      // return { x, y }\r\n\r\n      const { touches } = e\r\n      const { pageX, pageY } = touches[0]\r\n      const { x, y } = getOffsetPosition(pageX, pageY, this.el)\r\n\r\n      console.log('{ x, y }', { x, y })\r\n      return { x, y }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 获取合法的最大撤销步数\r\n   *\r\n   * @private\r\n   * @param {number} steps steps 步数\r\n   * @returns {number} 合法的最大撤销步数\r\n   * @memberof DrawingBoard\r\n   */\r\n  private _getLawfulMaxRevokeSteps(steps: number): number {\r\n    if (steps <= 0 || typeof steps !== 'number' || isNaN(steps))\r\n      return DrawingBoard.LIMIT_MIN_REVOKE_STEPS\r\n\r\n    if (steps > DrawingBoard.LIMIT_MAX_REVOKE_STEPS)\r\n      return DrawingBoard.LIMIT_MAX_REVOKE_STEPS\r\n\r\n    return steps\r\n  }\r\n\r\n  /**\r\n   * 获取模式对应的指针类型\r\n   * @param {string} mode 模式\r\n   * @returns 类型字符串\r\n   */\r\n  private _getPointerType(mode: INTERACTIVE_MODE): EventPointerType {\r\n    if (mode === 'both') {\r\n      return 'touchAndMouse'\r\n    } else if (mode === 'touch') {\r\n      return 'touch'\r\n    } else {\r\n      return 'mouse'\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 生成事件映射列表\r\n   *\r\n   * @private\r\n   * @returns {EventItem[]} 事件映射列表\r\n   * @memberof DrawingBoard\r\n   */\r\n  private _makeEventList(): EventItem[] {\r\n    return [\r\n      {\r\n        pointerType: 'mouse',\r\n        action: 'start',\r\n        name: 'mousedown',\r\n        handler: this._handlePointerStart,\r\n      },\r\n      {\r\n        pointerType: 'mouse',\r\n        action: 'move',\r\n        name: 'mousemove',\r\n        handler: this._handlePointerMove,\r\n      },\r\n      {\r\n        pointerType: 'mouse',\r\n        action: 'end',\r\n        name: 'mouseup',\r\n        handler: this._handlePointerEnd,\r\n      },\r\n      {\r\n        pointerType: 'mouse',\r\n        action: 'leave',\r\n        name: 'mouseleave',\r\n        handler: this._handlePointerLeave,\r\n      },\r\n      {\r\n        pointerType: 'touch',\r\n        action: 'start',\r\n        name: 'touchstart',\r\n        handler: this._handlePointerStart,\r\n      },\r\n      {\r\n        pointerType: 'touch',\r\n        action: 'move',\r\n        name: 'touchmove',\r\n        handler: this._handlePointerMove,\r\n      },\r\n      {\r\n        pointerType: 'touch',\r\n        action: 'end',\r\n        name: 'touchend',\r\n        handler: this._handlePointerEnd,\r\n      },\r\n      {\r\n        pointerType: 'touch',\r\n        action: 'cancel',\r\n        name: 'touchcancel',\r\n        handler: this._handlePointerCancel,\r\n      },\r\n    ]\r\n  }\r\n\r\n  /**\r\n   * 过滤出符合条件的EventItems\r\n   *\r\n   * @private\r\n   * @param {EventItemCondition} 过滤条件\r\n   * @returns {EventItem[]} EventItems数组\r\n   * @memberof DrawingBoard\r\n   */\r\n  private _getEventItems({\r\n    pointerType,\r\n    action,\r\n  }: EventItemCondition): EventItem[] {\r\n    let filterFn: any\r\n\r\n    // pointerType不指定或为touchAndMouse时，只过滤action\r\n    if (!pointerType || pointerType === 'touchAndMouse') {\r\n      if (action) {\r\n        filterFn = (item: EventItem) => item.action === action\r\n      } else {\r\n        // pointerType、action都为空，则返回所有\r\n        return this.eventList\r\n      }\r\n    } else {\r\n      // pointerType存在并不为touchAndMouse时，需要同时过滤pointerType和action\r\n      if (action) {\r\n        filterFn = (item: EventItem) =>\r\n          item.pointerType === pointerType && item.action === action\r\n      } else {\r\n        filterFn = (item: EventItem) => item.pointerType === pointerType\r\n      }\r\n    }\r\n\r\n    return this.eventList.filter(filterFn)\r\n  }\r\n\r\n  /**\r\n   * 生成canvas元素\r\n   *\r\n   * @private\r\n   * @returns {HTMLCanvasElement} canvas DOM对象\r\n   * @memberof DrawingBoard\r\n   */\r\n  private _makeCanvas(): HTMLCanvasElement {\r\n    return document.createElement('canvas')\r\n  }\r\n\r\n  /**\r\n   * 获取绘图上下文\r\n   *\r\n   * @private\r\n   * @returns {CanvasRenderingContext2D} 2d上下文\r\n   * @memberof DrawingBoard\r\n   */\r\n  private _getCtx(): CanvasRenderingContext2D {\r\n    const ctx = this.el && this.el.getContext && this.el.getContext('2d')\r\n    if (ctx == null) throw new Error(MSG_CTX_CANT_GET)\r\n\r\n    return ctx\r\n  }\r\n\r\n  /**\r\n   * 设置canvas transform\r\n   *\r\n   * @private\r\n   * @param {number} x 横轴\r\n   * @param {number} y 纵轴\r\n   * @param {number} scale 缩放比例\r\n   * @param {boolean} [transition=false] 过渡动画\r\n   * @memberof DrawingBoard\r\n   */\r\n  private _setCanvasTransform(\r\n    x: number,\r\n    y: number,\r\n    scale: number,\r\n    transition: boolean = false\r\n  ): void {\r\n    if (!this.el) return\r\n\r\n    const text = `transform:scale(${scale}) translate3d(${x}px,${y}px,0);transform-origin:center;`\r\n    const cssText = transition ? text + 'transition:0.3s;' : text\r\n\r\n    this.el.setAttribute('style', cssText)\r\n  }\r\n\r\n  /**\r\n   * 设置canvas dom尺寸\r\n   *\r\n   * @private\r\n   * @param {number[]} [width, height] 宽高数组\r\n   * @memberof DrawingBoard\r\n   */\r\n  private _setDOMSize([width, height]: number[]): void {\r\n    if (width != null && this.el) this.el.width = width\r\n    if (height != null && this.el) this.el.height = height\r\n  }\r\n\r\n  /**\r\n   * 设置画笔模式\r\n   *\r\n   * @private\r\n   * @param {PEN_MODE} mode 画笔模式\r\n   * @memberof DrawingBoard\r\n   */\r\n  private _setPenMode(mode: PEN_MODE): void {\r\n    if (!DrawingBoard.PEN_MODE_ENUM.includes(mode)) return\r\n\r\n    this.penMode = mode\r\n  }\r\n\r\n  /**\r\n   * 保存当前画布状态\r\n   *\r\n   * @private\r\n   * @param {PEN_MODE} [type='paint'] 类型(绘制paint、清空clear) 默认paint\r\n   * @param {number} paintCount 绘制次数\r\n   * @param {ImageData} imageData 像素数据\r\n   * @memberof DrawingBoard\r\n   */\r\n  private _saveImageData(\r\n    type = 'paint',\r\n    paintCount: number,\r\n    imageData: ImageData\r\n  ): void {\r\n    if (\r\n      !['paint', 'clear'].includes(type) ||\r\n      paintCount == null ||\r\n      !imageData ||\r\n      !(imageData instanceof ImageData)\r\n    ) {\r\n      return\r\n    }\r\n\r\n    if (this.revokeStack.length >= this.MAX_REVOKE_STEPS) {\r\n      this.revokeStack.shift()\r\n    }\r\n\r\n    // 保存类型及绘制次数(撤销时使用)\r\n    this.revokeStack.push({ type, paintCount, imageData })\r\n\r\n    this.onRevokeStackChange &&\r\n      typeof this.onRevokeStackChange === 'function' &&\r\n      this.onRevokeStackChange(this.revokeStack)\r\n\r\n    console.log('_saveImageData onRevokeStackChange', this.revokeStack)\r\n  }\r\n\r\n  /**\r\n   * 绑定当前模式对应动作的所有事件\r\n   * @param {String} action 动作\r\n   * @returns void\r\n   */\r\n  private _bindCurInteractiveModeEvents(action: EventAction): void {\r\n    if (!this.el) return\r\n\r\n    const pointerType = this._getPointerType(this.interactiveMode)\r\n\r\n    const condition: EventItemCondition = { pointerType, action }\r\n\r\n    this._cleanCurInteractiveModeEvents(condition)\r\n\r\n    this._bindEvent(condition)\r\n  }\r\n\r\n  /**\r\n   * 清除当前模式对应动作的所有事件\r\n   * @param {String} action 动作\r\n   * @returns void\r\n   */\r\n  private _cleanCurInteractiveModeEvents({ action }: EventItemCondition): void {\r\n    if (!this.el) return\r\n\r\n    const pointerType = this._getPointerType(this.interactiveMode)\r\n\r\n    const condition = { pointerType, action }\r\n\r\n    this._cleanEvent(condition)\r\n  }\r\n\r\n  /**\r\n   * 绑定符合特定条件的事件\r\n   * @param {Object} condition 过滤条件\r\n   * @returns void\r\n   */\r\n  private _bindEvent(condition: EventItemCondition = {}): void {\r\n    const eventItems = this._getEventItems(condition)\r\n    if (!eventItems || !eventItems.length) return\r\n\r\n    eventItems.forEach(({ name, handler }) => {\r\n      this.el && this.el.addEventListener(name, handler, false)\r\n    })\r\n  }\r\n\r\n  /**\r\n   * 清除符合特定条件的事件\r\n   * @param {Object} condition 过滤条件\r\n   * @returns void\r\n   */\r\n  private _cleanEvent(condition = {}): void {\r\n    const eventItems = this._getEventItems(condition)\r\n    if (!eventItems || !eventItems.length) return\r\n\r\n    eventItems.forEach(\r\n      ({ name, handler }) =>\r\n        this.el && this.el.removeEventListener(name, handler, false)\r\n    )\r\n  }\r\n\r\n  /**\r\n   * 单步撤销\r\n   *\r\n   * @private\r\n   * @memberof DrawingBoard\r\n   */\r\n  private _revoke(): void {\r\n    if (!this.ctx || !this.revokeStack || !this.revokeStack.length) return\r\n\r\n    const {\r\n      imageData,\r\n      paintCount: afterRevokePaintCount,\r\n    } = this.revokeStack.pop()\r\n\r\n    this.ctx.putImageData(imageData, 0, 0)\r\n\r\n    // 恢复绘制次数\r\n    this.paintCount = afterRevokePaintCount\r\n\r\n    this.onRevokeStackChange &&\r\n      typeof this.onRevokeStackChange === 'function' &&\r\n      this.onRevokeStackChange(this.revokeStack)\r\n\r\n    console.log(\r\n      '_revoke onRevokeStackChange',\r\n      this.revokeStack,\r\n      afterRevokePaintCount\r\n    )\r\n  }\r\n\r\n  /**\r\n   * 获取背景图并绘制\r\n   *\r\n   * @private\r\n   * @param {string} bgImgURL 背景图url\r\n   * @memberof DrawingBoard\r\n   */\r\n  private _getImgAndDraw(bgImgURL: string): void {\r\n    getImageFromURL(bgImgURL)\r\n      .then((image) => {\r\n        this._bgImgObject = image\r\n        // 保留原始尺寸，方便旋转时使用\r\n        this.originalSize = [image.width, image.height]\r\n        // TODO:此处存在异步问题，drawBg内部会使用ctx\r\n        this._drawBg(image, this.originalSize[0], this.originalSize[1])\r\n      })\r\n      .catch((err) => {\r\n        console.log(err)\r\n        this._bgImgObject = null\r\n      })\r\n  }\r\n\r\n  /**\r\n   * 绘制背景底图\r\n   *\r\n   * @private\r\n   * @param {CanvasImageSource} imgObject 图像对象\r\n   * @param {number} w 宽\r\n   * @param {number} h 高\r\n   * @memberof DrawingBoard\r\n   */\r\n  private _drawBg(imgObject: CanvasImageSource, w: number, h: number) {\r\n    if (\r\n      !imgObject ||\r\n      !this.ctx ||\r\n      !this.ctx.drawImage ||\r\n      !w ||\r\n      !h ||\r\n      w <= 0 ||\r\n      h <= 0\r\n    ) {\r\n      return\r\n    }\r\n\r\n    const sx = 0\r\n    const sy = 0\r\n    const sWidth = w\r\n    const sHeight = h\r\n\r\n    const dx =\r\n      this.bgImgRotate === 0 || this.bgImgRotate === 180\r\n        ? -this.width / 2\r\n        : -this.height / 2\r\n    const dy =\r\n      this.bgImgRotate === 0 || this.bgImgRotate === 180\r\n        ? -this.height / 2\r\n        : -this.width / 2\r\n\r\n    const dWidth =\r\n      this.bgImgRotate === 0 || this.bgImgRotate === 180\r\n        ? this.width\r\n        : this.height\r\n    const dHeight =\r\n      this.bgImgRotate === 0 || this.bgImgRotate === 180\r\n        ? this.height\r\n        : this.width\r\n\r\n    this.ctx.save()\r\n\r\n    this.ctx.translate(this.width / 2, this.height / 2)\r\n    this.ctx.rotate((Math.PI / 180) * this.bgImgRotate)\r\n\r\n    console.log(\r\n      '旋转参数:',\r\n      sx,\r\n      sy,\r\n      sWidth,\r\n      sHeight,\r\n      dx,\r\n      dy,\r\n      dWidth,\r\n      dHeight,\r\n      this.bgImgRotate\r\n    )\r\n\r\n    this.ctx.drawImage(\r\n      imgObject,\r\n      sx,\r\n      sy,\r\n      sWidth,\r\n      sHeight,\r\n      dx,\r\n      dy,\r\n      dWidth,\r\n      dHeight\r\n    )\r\n\r\n    this.ctx.restore()\r\n  }\r\n\r\n  /**\r\n   * 绘制圆形\r\n   *\r\n   * @private\r\n   * @param {number} x 横轴\r\n   * @param {number} y 纵轴\r\n   * @param {number} [radius=3] 半径\r\n   * @param {string} [color='red'] 画笔颜色\r\n   * @memberof DrawingBoard\r\n   */\r\n  private _drawCircle(x: number, y: number, radius = 3, color = 'red'): void {\r\n    if (!this.ctx) return\r\n    this.ctx.save()\r\n\r\n    this.ctx.fillStyle = color\r\n\r\n    this.ctx.beginPath()\r\n    this.ctx.arc(x, y, radius, 0, (Math.PI / 180) * 360, false)\r\n    this.ctx.fill()\r\n\r\n    this.ctx.restore()\r\n  }\r\n\r\n  /**\r\n   * 绘制移动时的直线\r\n   *\r\n   * @private\r\n   * @param {number} x1 起点x1\r\n   * @param {number} y1 起点y1\r\n   * @param {number} x2 终点x2\r\n   * @param {number} y2 终点y2\r\n   * @param {number} [width=6] 线条宽度\r\n   * @param {string} [color='red'] 线条颜色\r\n   * @memberof DrawingBoard\r\n   */\r\n  private _drawLine(\r\n    x1: number,\r\n    y1: number,\r\n    x2: number,\r\n    y2: number,\r\n    width = 6,\r\n    color = 'red'\r\n  ): void {\r\n    if (!this.ctx) return\r\n    this.ctx.save()\r\n\r\n    this.ctx.strokeStyle = color\r\n    this.ctx.lineWidth = width\r\n    this.ctx.lineCap = 'round'\r\n    this.ctx.lineJoin = 'round'\r\n\r\n    this.ctx.beginPath()\r\n    this.ctx.moveTo(x1, y1)\r\n    this.ctx.lineTo(x2, y2)\r\n    this.ctx.stroke()\r\n\r\n    this.ctx.restore()\r\n  }\r\n\r\n  /**\r\n   * 处理指针开始\r\n   *\r\n   * @private\r\n   * @param {Event} e 事件对象\r\n   * @returns void\r\n   * @memberof DrawingBoard\r\n   */\r\n  private _handlePointerStart = (e: MouseEvent | TouchEvent): void => {\r\n    console.log('_handlePointerStart', e.type)\r\n    if (this.penMode === 'empty') return\r\n\r\n    if (this.penMode === 'paint') this._handlePaintStart(e)\r\n\r\n    if (this.penMode === 'drag') this._handleDragStart(e)\r\n\r\n    this._bindCurInteractiveModeEvents('move')\r\n    this._bindCurInteractiveModeEvents('end')\r\n    this._bindCurInteractiveModeEvents('leave')\r\n  }\r\n\r\n  /**\r\n   * 处理绘制开始\r\n   *\r\n   * @private\r\n   * @param {Event} e 事件对象\r\n   * @memberof DrawingBoard\r\n   */\r\n  private _handlePaintStart(e: MouseEvent | TouchEvent): void {\r\n    this.isPainting = true\r\n\r\n    this.lastPaintPoint = this._getPointOffset(e)\r\n\r\n    console.log('handlePaintStart this.lastPaintPoint', e, this.lastPaintPoint)\r\n\r\n    // 绘制前保存状态\r\n    this.ctx &&\r\n      this._saveImageData(\r\n        'paint',\r\n        this.paintCount,\r\n        this.ctx.getImageData(0, 0, this.width, this.height)\r\n      )\r\n\r\n    this._drawCircle(\r\n      this.lastPaintPoint.x,\r\n      this.lastPaintPoint.y,\r\n      this.penWidth / 2,\r\n      this.penColor\r\n    )\r\n  }\r\n\r\n  /**\r\n   * 处理拖拽开始\r\n   */\r\n  private _handleDragStart(e: MouseEvent | TouchEvent): void {\r\n    console.log('drag start')\r\n\r\n    this.isDraging = true\r\n\r\n    this.lastDragPoint = this._getPointOffset(e)\r\n  }\r\n\r\n  /**\r\n   * 处理指针移动\r\n   *\r\n   * @private\r\n   * @param {Event} e 事件对象\r\n   * @returns void\r\n   * @memberof DrawingBoard\r\n   */\r\n  private _handlePointerMove = (e: MouseEvent | TouchEvent): void => {\r\n    console.log('_handlePointerMove')\r\n\r\n    if (this.penMode === 'empty') return\r\n\r\n    if (this.penMode === 'paint') this._handlePaintMove(e)\r\n\r\n    if (this.penMode === 'drag') this._handleDragMove(e)\r\n  }\r\n\r\n  /**\r\n   * 处理绘制移动\r\n   */\r\n  private _handlePaintMove(e: MouseEvent | TouchEvent): void {\r\n    if (this.isPainting) {\r\n      const { x, y } = this._getPointOffset(e)\r\n\r\n      if (this.lastPaintPoint == null)\r\n        throw new Error(MSG_LAST_PAINT_POINT_NOT_FOUNT)\r\n\r\n      const { x: lastX, y: lastY } = this.lastPaintPoint\r\n\r\n      this._drawLine(lastX, lastY, x, y, this.penWidth, this.penColor)\r\n      this.lastPaintPoint = { x, y }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 处理拖拽移动\r\n   *\r\n   * @private\r\n   * @param {(MouseEvent | TouchEvent)} e 事件对象\r\n   * @memberof DrawingBoard\r\n   */\r\n  private _handleDragMove(e: MouseEvent | TouchEvent): void {\r\n    console.log('drag move')\r\n    if (this.isDraging) {\r\n      const { x, y } = this._getPointOffset(e)\r\n\r\n      if (this.lastDragPoint == null)\r\n        throw new Error(MSG_LAST_DRAG_POINT_NOT_FOUNT)\r\n\r\n      const { x: lastX, y: lastY } = this.lastDragPoint\r\n\r\n      this.dragTransformX += x - lastX\r\n      this.dragTransformY += y - lastY\r\n\r\n      this._setCanvasTransform(\r\n        this.dragTransformX,\r\n        this.dragTransformY,\r\n        this.scale\r\n      )\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 处理指针结束\r\n   *\r\n   * @private\r\n   * @param {MouseEvent | TouchEvent} e 事件对象\r\n   * @returns void\r\n   * @memberof DrawingBoard\r\n   */\r\n  private _handlePointerEnd = (): void => {\r\n    console.log('_handlePointerEnd')\r\n\r\n    if (this.penMode === 'empty') return\r\n\r\n    if (this.penMode === 'paint') this._handlePaintEnd()\r\n\r\n    if (this.penMode === 'drag') this._handleDragEnd()\r\n\r\n    // 解绑相关事件\r\n    this._cleanCurInteractiveModeEvents({ action: 'move' })\r\n    this._cleanCurInteractiveModeEvents({ action: 'end' })\r\n    this._cleanCurInteractiveModeEvents({ action: 'leave' })\r\n  }\r\n\r\n  /**\r\n   * 处理绘制结束\r\n   */\r\n  private _handlePaintEnd(): void {\r\n    this.isPainting = false\r\n\r\n    this.paintCount++\r\n\r\n    this.onPaintEnd &&\r\n      typeof this.onPaintEnd === 'function' &&\r\n      this.onPaintEnd(this.paintCount)\r\n\r\n    console.log('_handlePointerEnd paintCount', this.paintCount)\r\n  }\r\n\r\n  /**\r\n   * 处理拖拽结束\r\n   */\r\n  private _handleDragEnd(): void {\r\n    console.log('drag end')\r\n\r\n    this.isDraging = false\r\n  }\r\n\r\n  /**\r\n   * 处理指针离开\r\n   *\r\n   * @private\r\n   * @param {Event} e 事件对象\r\n   * @returns void\r\n   * @memberof DrawingBoard\r\n   */\r\n  private _handlePointerLeave = (e: MouseEvent | TouchEvent): void => {\r\n    console.log('_handlePointerLeave')\r\n    if (this.isPainting || this.isDraging) this._handlePointerEnd()\r\n  }\r\n\r\n  /**\r\n   * 处理指针取消\r\n   *\r\n   * @private\r\n   * @param {Event} e 事件对象\r\n   * @returns void\r\n   * @memberof DrawingBoard\r\n   */\r\n  private _handlePointerCancel = (e: MouseEvent | TouchEvent): void => {\r\n    console.log('_handlePointerCancel')\r\n\r\n    if (this.isPainting || this.isDraging) this._handlePointerEnd()\r\n  }\r\n\r\n  /**\r\n   * 处理缩放比例改变\r\n   *\r\n   * @private\r\n   * @memberof DrawingBoard\r\n   */\r\n  private _handleScaleChange(): void {\r\n    if (!this.el) return\r\n\r\n    this._setCanvasTransform(\r\n      this.dragTransformX,\r\n      this.dragTransformY,\r\n      this.scale,\r\n      this.scaleTransition\r\n    )\r\n  }\r\n\r\n  /**\r\n   * 设置画笔样式(粗细、颜色)\r\n   *\r\n   * @param {PenStyle} { color, width } 样式\r\n   * @memberof DrawingBoard\r\n   */\r\n  setPenStyle({ color, width }: PenStyle): void {\r\n    if (color) this.penColor = this._getPenColor(color)\r\n    if (width) this.penWidth = this._getPenWidth(width)\r\n  }\r\n\r\n  /**\r\n   * 设置canvas尺寸\r\n   *\r\n   * @param {number[]} [width, height] 宽高数组\r\n   * @memberof DrawingBoard\r\n   */\r\n  setSize([width, height]: number[]): void {\r\n    if (width) this.width = width\r\n    if (height) this.height = height\r\n\r\n    this._setDOMSize([width, height])\r\n  }\r\n\r\n  /**\r\n   * 设置样式名\r\n   *\r\n   * @param {string} name 样式类字符串\r\n   * @memberof DrawingBoard\r\n   */\r\n  setClassName(name: string): void {\r\n    if (!name || !this.el) return\r\n\r\n    this.el.className = name\r\n  }\r\n\r\n  /**\r\n   * 设置画笔模式为绘制模式\r\n   *\r\n   * @memberof DrawingBoard\r\n   */\r\n  setPenModePaint(): void {\r\n    this._setPenMode('paint')\r\n  }\r\n\r\n  /**\r\n   * 设置画笔模式为拖拽模式\r\n   *\r\n   * @memberof DrawingBoard\r\n   */\r\n  setPenModeDrag(): void {\r\n    this._setPenMode('drag')\r\n  }\r\n\r\n  /**\r\n   * 重置画笔模式为空\r\n   *\r\n   * @memberof DrawingBoard\r\n   */\r\n  setPenModeEmpty(): void {\r\n    this._setPenMode('empty')\r\n  }\r\n\r\n  /**\r\n   * 设置缩放比例\r\n   *\r\n   * @param {*} scale 缩放比例\r\n   * @memberof DrawingBoard\r\n   */\r\n  setScale(scale: any): void {\r\n    let s = parseFloat(scale)\r\n    if (isNaN(s) || s === this.scale) return\r\n\r\n    this.scale = this._getLawfulScale(scale)\r\n\r\n    this._handleScaleChange()\r\n  }\r\n\r\n  /**\r\n   * 挂载\r\n   * @returns void\r\n   */\r\n  mount(): void {\r\n    if (!this.el) this.el = this._makeCanvas()\r\n    if (!this.ctx) this.ctx = this._getCtx()\r\n\r\n    this._setDOMSize([this.width, this.height])\r\n    this.setClassName(this.className)\r\n\r\n    this._bindCurInteractiveModeEvents('start')\r\n\r\n    this.container.appendChild(this.el)\r\n  }\r\n\r\n  /**\r\n   * 销毁\r\n   *\r\n   * @memberof DrawingBoard\r\n   */\r\n  destory(): void {\r\n    this.el && this.container.removeChild(this.el)\r\n    this.el = null\r\n    this._bgImgObject = null\r\n  }\r\n\r\n  /**\r\n   * 清空绘制\r\n   * @returns void\r\n   */\r\n  clear(): void {\r\n    if (!this.ctx || !this.el) return\r\n\r\n    // 清空前保存状态\r\n    this._saveImageData(\r\n      'clear',\r\n      this.paintCount,\r\n      this.ctx.getImageData(0, 0, this.width, this.height)\r\n    )\r\n\r\n    this.ctx.clearRect(0, 0, this.width, this.height)\r\n\r\n    // 重置绘制次数\r\n    this.paintCount = 0\r\n\r\n    // 如果有背景图，则需要重新绘制背景图\r\n    this._bgImgObject &&\r\n      this._drawBg(\r\n        this._bgImgObject,\r\n        this.originalSize[0],\r\n        this.originalSize[1]\r\n      )\r\n\r\n    console.log('clear paintCount', this.paintCount)\r\n  }\r\n\r\n  /**\r\n   * 旋转\r\n   *\r\n   * @param {number} [direction=1] 方向 1顺时针 -1逆时针\r\n   * @memberof DrawingBoard\r\n   */\r\n  rotate(direction = 1): void {\r\n    if (![1, -1].includes(direction)) return\r\n\r\n    this.bgImgRotate = this._getLawfulRotateAngle(\r\n      this.bgImgRotate + direction * 90\r\n    )\r\n\r\n    // 重设尺寸，旋转90度，宽高互换即可\r\n    this.setSize([this.height, this.width])\r\n\r\n    this._bgImgObject &&\r\n      this._drawBg(\r\n        this._bgImgObject,\r\n        this.originalSize[0],\r\n        this.originalSize[1]\r\n      )\r\n\r\n    // 因为旋转操作不记录到撤销栈中\r\n    // 旋转时需要清空撤销栈并重置绘制数量，不然会导致撤销状态错误\r\n    this.paintCount = 0\r\n    this.revokeStack = []\r\n  }\r\n\r\n  /**\r\n   * 撤销\r\n   * @returns void\r\n   */\r\n  revoke(): void {\r\n    this._revoke()\r\n  }\r\n\r\n  /**\r\n   * 设置背景\r\n   *\r\n   * @param {(CanvasImageSource | string)} urlOrObject 需要绘制的图像对象(HTMLImageElement、SVGImageElement、HTMLVideoElement、HTMLCanvasElement、ImageBitmap、OffscreenCanvas)或图像url\r\n   * @param {number} originalWidth 原图像宽度。当无法从urlOrObject直接获取原始尺寸时需要手动提供原始尺寸\r\n   * @param {number} originalHeight 原图像高度\r\n   * @memberof DrawingBoard\r\n   */\r\n  setBgImg(\r\n    urlOrObject: CanvasImageSource | string,\r\n    originalWidth: number,\r\n    originalHeight: number\r\n  ): void {\r\n    // TODO:此处可能需要保存状态\r\n    if (typeof urlOrObject === 'string') {\r\n      // 从url中获取图片对象\r\n      if (/^(http[s]?)|(data:image)/.test(urlOrObject)) {\r\n        getImageFromURL(urlOrObject)\r\n          .then((image) => {\r\n            this._bgImgObject = image\r\n            this.originalSize = [\r\n              originalWidth || image.width,\r\n              originalHeight || image.height,\r\n            ]\r\n\r\n            this._drawBg(image, this.originalSize[0], this.originalSize[1])\r\n          })\r\n          .catch((err) => {\r\n            console.log(err)\r\n            this._bgImgObject = null\r\n          })\r\n      } else {\r\n        throw new Error(MSG_BG_URL_NOT_LAWFUL)\r\n      }\r\n    } else {\r\n      // 传入的是新图片对象\r\n      if (urlOrObject !== this._bgImgObject) this._bgImgObject = urlOrObject\r\n      this.originalSize = [\r\n        originalWidth || this.width,\r\n        originalHeight || this.height,\r\n      ]\r\n\r\n      this._drawBg(urlOrObject, this.originalSize[0], this.originalSize[1])\r\n    }\r\n  }\r\n\r\n  /**\r\n   * scale + scaleStep\r\n   *\r\n   * @memberof DrawingBoard\r\n   */\r\n  makeScaleAdd(): void {\r\n    let newScale = this.scale + this.scaleStep\r\n    this.setScale(newScale)\r\n  }\r\n\r\n  /**\r\n   * scale - scaleStep\r\n   *\r\n   * @memberof DrawingBoard\r\n   */\r\n  makeScaleSubtract(): void {\r\n    const newScale = this.scale - this.scaleStep\r\n    this.setScale(newScale)\r\n  }\r\n\r\n  /**\r\n   * 重置缩放比例、位置\r\n   *\r\n   * @memberof DrawingBoard\r\n   */\r\n  reset(): void {\r\n    this.dragTransformX = this.dragTransformY = 0\r\n\r\n    this.scale = this.initialScale\r\n\r\n    this._setCanvasTransform(\r\n      this.dragTransformX,\r\n      this.dragTransformY,\r\n      this.scale,\r\n      this.scaleTransition\r\n    )\r\n  }\r\n\r\n  /**\r\n   * 获取当前画面的绘制次数\r\n   *\r\n   * @returns {number} 绘制次数\r\n   * @memberof DrawingBoard\r\n   */\r\n  getPaintCount(): number {\r\n    return this.paintCount\r\n  }\r\n\r\n  /**\r\n   * 获取dataURL\r\n   *\r\n   * @param {IMG_TYPE} [type='png'] 图片类型\r\n   * @param {number} [compressRate=1] 压缩比率\r\n   * @returns dataURL\r\n   * @memberof DrawingBoard\r\n   */\r\n  getDataUrl(type: IMG_TYPE = 'png', compressRate = 1): string {\r\n    if (\r\n      !this.el ||\r\n      !DrawingBoard.IMG_TYPE_ENUM.includes(type) ||\r\n      typeof compressRate !== 'number' ||\r\n      isNaN(compressRate)\r\n    ) {\r\n      throw new Error(MSG_DATAURL_CANT_GEN)\r\n    }\r\n\r\n    if (compressRate < 0.3) compressRate = 0.3\r\n    if (compressRate > 1) compressRate = 1\r\n\r\n    // ! toDataURL不支持image/jpg类型，若不支持，其会转为image/png\r\n    // ! 在特定情况下，会使图片体积变大\r\n    // ! 正确的应该是image/jpeg\r\n    const resourceType = `image/${type === 'jpg' ? 'jpeg' : type}`\r\n\r\n    return this.el.toDataURL(resourceType, compressRate)\r\n  }\r\n\r\n  /**\r\n   * 获取Blob\r\n   *\r\n   * @param {IMG_TYPE} [type='png'] 图片类型\r\n   * @param {number} [compressRate=1] 压缩比率\r\n   * @returns {Promise<Blob>} 返回blob\r\n   * @memberof DrawingBoard\r\n   */\r\n  getBlob(type: IMG_TYPE = 'png', compressRate = 1): Promise<Blob> {\r\n    if (\r\n      !this.el ||\r\n      !DrawingBoard.IMG_TYPE_ENUM.includes(type) ||\r\n      typeof compressRate !== 'number' ||\r\n      isNaN(compressRate)\r\n    ) {\r\n      throw new Error(MSG_BLOB_CANT_GEN)\r\n    }\r\n\r\n    if (compressRate < 0.3) compressRate = 0.3\r\n    if (compressRate > 1) compressRate = 1\r\n\r\n    const resourceType = `image/${type}`\r\n\r\n    return new Promise((resolve, reject) => {\r\n      this.el &&\r\n        this.el.toBlob(\r\n          (blob) => {\r\n            if (blob != null) resolve(blob)\r\n          },\r\n          resourceType,\r\n          compressRate\r\n        )\r\n    })\r\n  }\r\n\r\n  /**\r\n   * 获取File\r\n   *\r\n   * @param {string} [name='drawingBoard'] 图片名称\r\n   * @param {IMG_TYPE} [type='png'] 图片类型\r\n   * @param {number} [compressRate=1] 压缩比率\r\n   * @returns {(Promise<File | IeCompatibleBlob>)} 返回FIle或IeCompatibleBlob\r\n   * @memberof DrawingBoard\r\n   */\r\n  getFile(\r\n    name = 'drawingBoard',\r\n    type: IMG_TYPE = 'png',\r\n    compressRate = 1\r\n  ): Promise<File | IeCompatibleBlob> {\r\n    return this.getBlob(type, compressRate).then((blob) =>\r\n      blob2File(blob, name)\r\n    )\r\n  }\r\n\r\n  /**\r\n   * 下载图片\r\n   *\r\n   * @param {IMG_TYPE} [type='png'] 图片类型\r\n   * @param {number} [compressRate=1] 压缩比率，默认原图输出\r\n   * @param {string} [name='drawing-board'] 图片名称\r\n   * @memberof DrawingBoard\r\n   */\r\n  download(\r\n    type: IMG_TYPE = 'png',\r\n    compressRate = 1,\r\n    name = 'drawing-board'\r\n  ): void {\r\n    if (\r\n      !DrawingBoard.IMG_TYPE_ENUM.includes(type) ||\r\n      typeof compressRate !== 'number' ||\r\n      isNaN(compressRate)\r\n    ) {\r\n      return\r\n    }\r\n\r\n    if (compressRate < 0.3) compressRate = 0.3\r\n    if (compressRate > 1) compressRate = 1\r\n\r\n    const url = this.getDataUrl(type, compressRate)\r\n\r\n    if (url) {\r\n      let link: HTMLAnchorElement | null = document.createElement('a')\r\n      document.body.appendChild(link)\r\n      link.href = url\r\n      link.download = `${name}-${new Date().getTime()}`\r\n      link.target = '_blank'\r\n      link.click()\r\n\r\n      let timer: any = setTimeout(() => {\r\n        link && document.body.removeChild(link)\r\n        link = null\r\n\r\n        clearTimeout(timer)\r\n        timer = null\r\n      }, 200)\r\n    }\r\n  }\r\n}\r\n\r\nexport default DrawingBoard\r\n","/**\r\n * @author GuangHui\r\n * @description 错误提示\r\n */\r\n\r\nexport const MSG_CONTAINER_MISS_SELECTOR = 'container为必填项'\r\nexport const MSG_CONTAINER_NOT_FOUND = '找不到container'\r\n\r\nexport const MSG_ANGLE_NOT_LAWFUL = '请传入合法的角度值'\r\n\r\nexport const MSG_CTX_CANT_GET = '无法获取到context'\r\n\r\nexport const MSG_LAST_DRAG_POINT_NOT_FOUNT = 'lastDragPoint无法获取'\r\nexport const MSG_LAST_PAINT_POINT_NOT_FOUNT = 'lastPaintPoint无法获取'\r\n\r\nexport const MSG_EVENT_TARGET_NOT_FOUNT = 'target无法获取'\r\n\r\nexport const MSG_BG_URL_NOT_LAWFUL = '请传入合法的url'\r\n\r\nexport const MSG_BLOB_CANT_GEN = '生成blob错误'\r\n\r\nexport const MSG_DATAURL_CANT_GEN = '生成dataURL错误'\r\n"],"names":["blob2File","blob","name","isIE","lastModifiedDate","Date","File","type","getOffsetPosition","x","y","elOrCache","getVertexPosition","el","currentTarget","top","left","offsetTop","offsetLeft","offsetParent","getTranformData","style","window","getComputedStyle","transform","transformOrigin","origin","matrix","ones","originArray","split","parseInt","matrixString","match","stringArray","temp_1","forEach","value","push","parseFloat","trim","inv","computPosition","data","obj","_a","temp","_b","result","multiply","Node","nodeType","top_1","transformData","origin_1","length","vertex","unshift","parentNode","Array","pos","inBrowser","UA","navigator","userAgent","toLowerCase","test","getImageFromURL","imgURL","Promise","resolve","reject","Error","image","Image","src","onload","onerror","complete","$","selector","document","querySelector","Math","PI","container","options","e","console","log","_this","penMode","_handlePaintStart","_handleDragStart","_bindCurInteractiveModeEvents","_handlePaintMove","_handleDragMove","_handlePaintEnd","_handleDragEnd","_cleanCurInteractiveModeEvents","action","isPainting","isDraging","_handlePointerEnd","_getContainer","originalOptions","DrawingBoard","_defaultOptions","size","className","manualMount","maxRevokeSteps","interactiveMode","penColor","penWidth","bgImgURL","bgImgRotate","bgColor","onRevokeStackChange","onPaintEnd","minScale","maxScale","initialScale","scaleTransition","scaleStep","width","height","DEFAULT_WIDTH","DEFAULT_HEIGHT","setSize","revokeStack","MAX_REVOKE_STEPS","_getLawfulMaxRevokeSteps","lastPaintPoint","lastDragPoint","dragTransformX","dragTransformY","_getPenMode","_getInteractiveMode","eventList","_makeEventList","_getPenColor","_getPenWidth","_getClassName","_getLawfulRotateAngle","_bgImgObject","originalSize","_getImgAndDraw","paintCount","isNaN","_getLawfulMinScale","_getLawfulMaxScale","_getLawfulScale","scale","setTimeout","_handleScaleChange","overflow","ctx","mount","DEFAULT_SCALE","LIMIT_MIN_SCALE","DEFAULT_MAX_SCALE","mode","INTERACTIVE_MODE_ENUM","includes","PEN_MODE_ENUM","HTMLElement","color","angle","abs","floor","ceil","tempAngle","newAngle","roundAngle","MouseEvent","offsetX","offsetY","touches","pageX","pageY","steps","LIMIT_MIN_REVOKE_STEPS","LIMIT_MAX_REVOKE_STEPS","pointerType","handler","_handlePointerStart","_handlePointerMove","_handlePointerLeave","_handlePointerCancel","filterFn","item","filter","createElement","getContext","transition","text","cssText","setAttribute","imageData","ImageData","shift","_getPointerType","condition","_bindEvent","_cleanEvent","eventItems","_getEventItems","addEventListener","removeEventListener","afterRevokePaintCount","putImageData","then","_drawBg","catch","err","imgObject","w","h","drawImage","sy","sWidth","sHeight","dx","dy","dWidth","dHeight","save","translate","rotate","restore","radius","fillStyle","beginPath","arc","fill","x1","y1","x2","y2","strokeStyle","lineWidth","lineCap","lineJoin","moveTo","lineTo","stroke","_getPointOffset","_saveImageData","getImageData","_drawCircle","lastX","lastY","_drawLine","_setCanvasTransform","_setDOMSize","_setPenMode","s","_makeCanvas","_getCtx","setClassName","appendChild","removeChild","clearRect","direction","_revoke","urlOrObject","originalWidth","originalHeight","newScale","setScale","compressRate","IMG_TYPE_ENUM","resourceType","toDataURL","toBlob","getBlob","url","getDataUrl","link_1","body","href","download","getTime","target","click","timer_1","clearTimeout"],"mappings":"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"}